<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solidity Invariant Fuzzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
</head>
<body>
    <h1>Solidity Invariant Fuzzer</h1>

    <!-- Step 1: Input Solidity Code -->
    <h2>Step 1: Input Solidity Code</h2>
    <div id="editor" style="height: 300px; width: 100%;"></div>
    <button id="submitCode">Submit Code</button>

    <!-- Step 2: Potential Invariants -->
    <h2>Step 2: Potential Invariants</h2>
    <div id="invariants"></div>

    <!-- Step 3: Select Invariants and Generate Tests -->
    <h2>Step 3: Select Invariants and Generate Tests</h2>
    <button id="generateTests" disabled>Generate Tests</button>

    <!-- Step 4: Generated Test Files -->
    <h2>Step 4: Generated Test Files</h2>
    <div id="generatedTests"></div>

    <!-- Step 5: Run Echidna Fuzzing -->
    <h2>Step 5: Run Echidna Fuzzing</h2>
    <button id="runEchidna">Run Echidna</button>

    <script>
        // Initialize Ace Editor
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/github");
        editor.session.setMode("ace/mode/solidity");

        // Step 1: Handle Submit Code
        document.getElementById('submitCode').addEventListener('click', async function() {
            var code = editor.getValue();

            // Send code to backend for processing by ChatGPT
            const response = await fetch('/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'solidityCode=' + encodeURIComponent(code)
            });

            const data = await response.json();

            // Step 2: Display potential invariants
            if (data.success) {
                const invariantContainer = document.getElementById('invariants');
                invariantContainer.innerHTML = '';
                data.invariants.forEach((invariant, index) => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = 'invariant-' + index;
                    checkbox.value = invariant;
                    const label = document.createElement('label');
                    label.setAttribute('for', 'invariant-' + index);
                    label.textContent = invariant;
                    invariantContainer.appendChild(checkbox);
                    invariantContainer.appendChild(label);
                    invariantContainer.appendChild(document.createElement('br'));
                });

                // Enable "Generate Tests" button
                document.getElementById('generateTests').disabled = false;
            }
        });

        // Step 3: Handle Generate Tests
        document.getElementById('generateTests').addEventListener('click', async function() {
            // Get selected invariants
            const selectedInvariants = [];
            document.querySelectorAll('#invariants input:checked').forEach((checkbox) => {
                selectedInvariants.push(checkbox.value);
            });

            // Send selected invariants and code back to backend to generate tests
            const code = editor.getValue();
            const response = await fetch('/generate-tests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: code,
                    invariants: selectedInvariants,
                }),
            });

            const data = await response.json();

            // Step 4: Display generated tests
            if (data.success) {
                const generatedTestsContainer = document.getElementById('generatedTests');
                generatedTestsContainer.innerHTML = data.tests.join('<br>');
            }
        });

        // Step 5: Handle Run Echidna
        document.getElementById('runEchidna').addEventListener('click', async function() {
            const response = await fetch('/run-echidna', {
                method: 'POST',
            });

            const data = await response.json();
            if (data.success) {
                alert('Echidna fuzzing has started!');
            } else {
                alert('Error running Echidna');
            }
        });
    </script>
</body>
</html>
