<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solidity Invariant Fuzzer</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
</head>
<body>
    <div class="container">
        <h1>Solidity Invariant Fuzzer</h1>

        <section>
            <h2>Step 1: Input Solidity Code</h2>
            <div id="editor">// Enter your Solidity code here
contract Example {
    uint public value;
    
    function setValue(uint _value) public {
        value = _value;
    }
}</div>
            <button id="submitCode">Submit Code</button>
        </section>

        <section>
            <h2>Step 2: Potential Invariants</h2>
            <div id="invariants"></div>
        </section>

        <section>
            <h2>Step 3: Generate Tests</h2>
            <button id="generateTests" disabled>Generate Tests</button>
            <div id="generatedTests"></div>
        </section>

        <section>
            <h2>Step 4: Run Echidna</h2>
            <button id="runEchidna">Run Echidna</button>
            <div id="fuzzerOutput"></div>
        </section>
    </div>

    <script>
        // Initialize Ace Editor
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");
        editor.setFontSize(14);

        // Submit Code  
        document.getElementById('submitCode').addEventListener('click', async function() {
            const invariantContainer = document.getElementById('invariants');
            invariantContainer.innerHTML = '<p>Analyzing code...</p>';
            
            try {
                const code = editor.getValue();
                const response = await fetch('/submit-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ solidityCode: code })
                });

                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }

                invariantContainer.innerHTML = '';
                
                if (data.success && Array.isArray(data.invariants)) {
                    if (data.invariants.length === 0) {
                        invariantContainer.innerHTML = '<p>No invariants found.</p>';
                    } else {
                        data.invariants.forEach((invariant, index) => {
                            const div = document.createElement('div');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `invariant-${index}`;
                            checkbox.value = invariant;
                            
                            const label = document.createElement('label');
                            label.htmlFor = `invariant-${index}`;
                            label.textContent = invariant;
                            
                            div.appendChild(checkbox);
                            div.appendChild(label);
                            div.appendChild(document.createElement('br'));
                            invariantContainer.appendChild(div);
                        });
                        document.getElementById('generateTests').disabled = false;
                    }
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error:', error);
                invariantContainer.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        });

        // Generate Tests
        document.getElementById('generateTests').addEventListener('click', async function() {
            try {
                const selectedInvariants = Array.from(document.querySelectorAll('#invariants input:checked')).map(cb => cb.value);
                const code = editor.getValue();

                const response = await fetch('/generate-tests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        solidityCode: code,
                        invariants: selectedInvariants,
                    }),
                });

                const data = await response.json();
                if (data.success) {
                    const generatedTestsContainer = document.getElementById('generatedTests');
                    generatedTestsContainer.innerHTML = `<pre>${data.testFiles}</pre>`;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating tests: ' + error.message);
            }
        });

        // Run Echidna
        document.getElementById('runEchidna').addEventListener('click', async function() {
            try {
                const response = await fetch('/run-echidna', {
                    method: 'POST',
                });

                const data = await response.json();
                const outputContainer = document.getElementById('fuzzerOutput');
                outputContainer.innerHTML = `<pre>${data.message}</pre>`;
            } catch (error) {
                console.error('Error:', error);
                alert('Error running Echidna: ' + error.message);
            }
        });
    </script>
</body>
</html>